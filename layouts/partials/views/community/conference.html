{{/* 兼容单个item和多个items的调用方式 */}}
{{ $allItems := slice }}

{{/* 如果传入的是单个item */}}
{{ if .item }}
  {{ $allItems = slice .item }}
{{/* 如果传入的是items列表 */}}
{{ else if .items }}
  {{ $allItems = .items }}
{{/* 如果传入的是直接的页面列表 */}}
{{ else if . }}
  {{ $allItems = . }}
{{ end }}

{{ if $allItems }}
  {{/* 收集所有有效的talk项目 */}}
  {{ $validItems := slice }}
  
  {{ range $allItems }}
    {{ $item := . }}
    {{ $isValidTalk := false }}

    {{/* 检查项目是否属于 talk 类型 */}}
    {{ if and $item.File (strings.Contains $item.File.Path "talk/") }}
      {{ $isValidTalk = true }}
    {{ end }}
    
    {{ if eq $item.Section "talk" }}
      {{ $isValidTalk = true }}
    {{ end }}
    
    {{ if eq $item.Type "talk" }}
      {{ $isValidTalk = true }}
    {{ end }}
    
    {{ if and $item.Params.event (or $item.Params.location $item.Params.presentation) }}
      {{ $isValidTalk = true }}
    {{ end }}

    {{ if $isValidTalk }}
      {{ $validItems = $validItems | append $item }}
    {{ end }}
  {{ end }}

  {{ if $validItems }}
    {{/* 按日期倒序排序 */}}
    {{ $sortedItems := sort $validItems "Date" "desc" }}
    
    {{/* 手动分组：先收集所有唯一年份 */}}
    {{ $allYears := slice }}
    {{ range $sortedItems }}
      {{ $year := dateFormat "2006" .Date }}
      {{ $allYears = $allYears | append $year }}
    {{ end }}
    {{ $uniqueYears := uniq $allYears }}
    {{ $sortedYears := sort $uniqueYears "value" "desc" }}
    
    {{/* 按年份分组显示 */}}
    {{ range $sortedYears }}
      {{ $currentYear := . }}
      
      <div class="mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-2">{{ $currentYear }}</h2>
        <hr class="border-t-2 border-gray-300 mb-4">
        
        {{/* 显示这一年的所有项目 */}}
        {{ range $sortedItems }}
          {{ $item := . }}
          {{ $itemYear := dateFormat "2006" $item.Date }}
          
          {{ if eq $itemYear $currentYear }}
            <div class="mb-4 pl-2">
              <h3 class="font-semibold text-lg">{{ $item.Title }}</h3>
              
              {{ with $item.Params.event }}
                <p class="text-gray-600 italic">{{ . }}</p>
              {{ end }}
              
              <div class="text-sm text-gray-500 mt-1">
                {{ with $item.Params.location }}
                  <span>{{ . }}</span>
                {{ end }}
                
                {{ with $item.Date }}
                  <span class="ml-2">{{ dateFormat "January 2, 2006" . }}</span>
                {{ end }}
                
                {{ if and $item.Params.date_end (ne $item.Date $item.Params.date_end) }}
                  {{ $endDate := time $item.Params.date_end }}
                  <span> - {{ dateFormat "January 2, 2006" $endDate }}</span>
                {{ end }}
              </div>
              
              {{ with $item.Params.presentation }}
                <div class="mt-2">
                  <span class="text-sm text-gray-600">{{ . }}</span>
                </div>
              {{ end }}
              
              {{ with $item.Summary }}
                <p class="text-sm text-gray-600 mt-2">{{ . }}</p>
              {{ end }}
            </div>
          {{ end }}
        {{ end }}
      </div>
    {{ end }}
    
  {{ else }}
    <div class="bg-yellow-50 border border-yellow-200 rounded p-4">
      <p class="text-yellow-800">没有找到符合条件的会议演示。</p>
    </div>
  {{ end }}
  
{{ else }}
  <div class="bg-yellow-50 border border-yellow-200 rounded p-4">
    <p class="text-yellow-800">没有找到项目数据。请检查调用方式。</p>
  </div>
{{ end }}