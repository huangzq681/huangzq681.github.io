{{ $items := .items }}

{{ if $items }}
  {{/* æŒ‰å¹´ä»½åˆ†ç»„ */}}
  {{ $itemsByYear := dict }}
  
  {{ range $items }}
    {{ $item := . }}
    {{ $isValidTalk := false }}

    {{/* æ£€æŸ¥é¡¹ç›®æ˜¯å¦å±äº talk ç±»å‹ */}}
    {{ if and $item.File (strings.Contains $item.File.Path "talk/") }}
      {{ $isValidTalk = true }}
    {{ end }}
    
    {{ if eq $item.Section "talk" }}
      {{ $isValidTalk = true }}
    {{ end }}
    
    {{ if eq $item.Type "talk" }}
      {{ $isValidTalk = true }}
    {{ end }}
    
    {{ if and $item.Params.event (or $item.Params.location $item.Params.presentation) }}
      {{ $isValidTalk = true }}
    {{ end }}

    {{ if $isValidTalk }}
      {{ $year := dateFormat "2006" $item.Date }}
      {{ $yearItems := index $itemsByYear $year }}
      {{ if not $yearItems }}
        {{ $yearItems = slice }}
      {{ end }}
      {{ $yearItems = $yearItems | append $item }}
      {{ $itemsByYear = merge $itemsByYear (dict $year $yearItems) }}
    {{ end }}
  {{ end }}

  {{/* æŒ‰å¹´ä»½å€’åºæ’åˆ—å¹¶æ˜¾ç¤º */}}
  {{ $years := sort (keys $itemsByYear) "value" "desc" }}
  
  {{ range $years }}
    {{ $year := . }}
    {{ $yearItems := index $itemsByYear $year }}
    
    <div class="mb-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-2">{{ $year }}</h2>
      <hr class="border-t-2 border-gray-300 mb-4">
      
      {{ range $yearItems }}
        {{ $item := . }}
        <div class="mb-4 border border-gray-200 rounded p-3">
          <div class="pl-2">
            <h3 class="font-semibold text-lg">{{ $item.Title }}</h3>
            
            {{ with $item.Params.event }}
              <p class="text-gray-600 italic">{{ . }}</p>
            {{ end }}
            
            <div class="text-sm text-gray-500 mt-1">
              {{ with $item.Params.location }}
                <span>ğŸ“ {{ . }}</span>
              {{ end }}
              
              {{ with $item.Date }}
                <span class="ml-2">ğŸ“… {{ dateFormat "January 2, 2006" . }}</span>
              {{ end }}
              
              {{ if and $item.Params.date_end (ne $item.Date $item.Params.date_end) }}
                {{ $endDate := time $item.Params.date_end }}
                <span> - {{ dateFormat "January 2, 2006" $endDate }}</span>
              {{ end }}
            </div>
            
            {{ with $item.Params.presentation }}
              <div class="mt-2">
                <span class="inline-block bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded">
                  {{ . }}
                </span>
              </div>
            {{ end }}
            
            {{ with $item.Summary }}
              <p class="text-sm text-gray-600 mt-2">{{ . }}</p>
            {{ end }}
          </div>
        </div>
      {{ end }}
    </div>
  {{ end }}
  
{{ else }}
  <div class="bg-yellow-50 border border-yellow-200 rounded p-4">
    <p class="text-yellow-800">æ²¡æœ‰æ‰¾åˆ°é¡¹ç›®æ•°æ®ã€‚</p>
  </div>
{{ end }}
